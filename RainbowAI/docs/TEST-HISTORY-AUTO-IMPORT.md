# Test History Auto-Import Feature

**Created**: 2026-02-13
**Purpose**: Automatically import CLI test reports into the dashboard's Test History

## Overview

Test reports generated by CLI scripts (`test-autotest-optimized.js`, `test-multilingual-concurrent.js`) now automatically appear in the Rainbow Dashboard's Test History without manual intervention.

## How It Works

### 1. **Scripts Save Reports**
Both test scripts save HTML reports to two locations:
- `reports/autotest/` - Archive directory
- `src/public/reports/autotest/` - Public directory (scanned by API)

### 2. **API Scans Reports**
New endpoint: `GET /api/rainbow/tests/scan-reports`

Scans `src/public/reports/autotest/` directory and parses HTML reports to extract:
- Filename
- Timestamp (file modification time)
- Total tests
- Passed count
- Warnings count
- Failed count
- Duration

### 3. **Dashboard Auto-Imports**
On page load, `loadImportedReports()` function:
1. Loads existing reports from `localStorage`
2. Fetches new reports from `/api/rainbow/tests/scan-reports`
3. Merges new reports (deduplicates by filename)
4. Saves to `localStorage` (`'rainbow-imported-reports'`)
5. Updates UI to show new entries

### 4. **User Views in Dashboard**
User opens: `http://localhost:3002/admin/rainbow` → Chat Simulator → Test History

Reports appear with:
- ✅ Passed count (green)
- ⚠️ Warnings count (yellow)
- ❌ Failed count (red)
- ⏱ Duration
- Pass percentage
- "View Report →" link (opens HTML report)

## Files Modified

### Backend

**File**: `RainbowAI/src/routes/admin/testing.ts`

Added endpoints:
```typescript
// POST /api/rainbow/tests/register-result
// For future use - manual registration of results

// GET /api/rainbow/tests/scan-reports
// Scans src/public/reports/autotest/ and returns metadata
```

Key implementation:
- Uses regex to parse HTML report statistics
- Returns array of report metadata
- Sorts by timestamp (newest first)

### Frontend

**File**: `RainbowAI/src/public/js/legacy-functions.js`

Modified functions:
```javascript
// loadAutotestHistory() - now async, awaits loadImportedReports()
// loadImportedReports() - now async, fetches from API
```

Key changes:
- Added API fetch to scan reports
- Deduplication by filename
- Auto-save to localStorage
- Console logging for debugging

### Test Scripts

**Files**:
- `RainbowAI/scripts/test-autotest-optimized.js`
- `RainbowAI/scripts/test-multilingual-concurrent.js`

Changes:
- Added message after report generation:
  ```
  ✨ Auto-imported to Test History!
     Open dashboard → Chat Simulator → Test History to view
  ```

## Usage

### Run Tests
```bash
cd RainbowAI

# Run full autotest suite (56 tests, concurrency 2, ~5 min)
node scripts/test-autotest-optimized.js

# Run multilingual tests (18 tests, ~6 sec)
node scripts/test-multilingual-concurrent.js

# Run benchmark (tests all concurrency levels)
node scripts/test-autotest-optimized.js --benchmark
```

### View in Dashboard
```bash
# Open dashboard
http://localhost:3002/admin/rainbow

# Navigate
→ Click "Chat Simulator" tab (yellow icon)
→ Scroll down to "Autorun" section
→ Click "View Test History" button
→ See your test reports listed!
```

### Expected Behavior
1. Script prints: `✨ Auto-imported to Test History!`
2. Open dashboard (or refresh if already open)
3. Click "View Test History"
4. See new report at top of list
5. Click report to view full HTML details

## Data Format

### Report Metadata (API Response)
```json
{
  "reports": [
    {
      "id": "imported-1707849123456",
      "filename": "rainbow-autotest-optimized-2026-02-13-17-05-23.html",
      "timestamp": "2026-02-13T17:05:23.456Z",
      "total": 56,
      "passed": 39,
      "warnings": 2,
      "failed": 15,
      "duration": 293100,
      "isImported": true
    }
  ]
}
```

### localStorage Format
Same as API response, stored in:
- Key: `'rainbow-imported-reports'`
- Value: JSON array of report objects

## HTML Report Parsing

The API scans HTML reports using regex patterns:

```javascript
// Total tests
/<div class="num" style="color:#333">(\d+)<\/div><div class="label">Total<\/div>/

// Passed (green)
/<div class="num" style="color:#16a34a">(\d+)<\/div><div class="label">Passed<\/div>/

// Warnings (yellow)
/<div class="num" style="color:#ca8a04">(\d+)<\/div><div class="label">Warnings<\/div>/

// Failed (red)
/<div class="num" style="color:#dc2626">(\d+)<\/div><div class="label">Failed<\/div>/

// Duration (purple)
/<div class="num" style="color:#6366f1">([0-9.]+)s<\/div><div class="label">Duration<\/div>/
```

These match the HTML generated by both test scripts.

## Troubleshooting

### Reports Don't Appear in History

**Check 1: Report saved to public directory?**
```bash
ls RainbowAI/src/public/reports/autotest/
# Should see .html files
```

**Check 2: API endpoint working?**
```bash
curl http://localhost:3002/api/rainbow/tests/scan-reports
# Should return JSON with reports array
```

**Check 3: Browser console logs**
```javascript
// Open browser console (F12)
// Look for: "[Test History] Auto-imported N new reports"
```

**Check 4: localStorage**
```javascript
// Browser console
JSON.parse(localStorage.getItem('rainbow-imported-reports'))
// Should show array of reports
```

### Clear and Rescan
```javascript
// Browser console - clear localStorage
localStorage.removeItem('rainbow-imported-reports');

// Refresh page - will rescan all reports
location.reload();
```

### Manual Import (Fallback)
If auto-import fails, manually copy report metadata:
```javascript
// Browser console
const report = {
  id: 'imported-' + Date.now(),
  filename: 'rainbow-autotest-optimized-2026-02-13-17-05-23.html',
  timestamp: '2026-02-13T17:05:23.456Z',
  total: 56,
  passed: 39,
  warnings: 2,
  failed: 15,
  duration: 293100,
  isImported: true
};

const saved = localStorage.getItem('rainbow-imported-reports');
const reports = saved ? JSON.parse(saved) : [];
reports.push(report);
localStorage.setItem('rainbow-imported-reports', JSON.stringify(reports));
location.reload();
```

## Architecture Decisions

### Why Not Server-Side Storage?
- `localStorage` is already used for Test History
- Keeps history per-browser (privacy)
- No database schema changes needed
- Fast client-side rendering

### Why Scan on Page Load?
- Automatic (no user action)
- Always up-to-date
- No polling overhead
- Simple implementation

### Why Deduplicate by Filename?
- Filenames are unique (timestamp-based)
- Avoids duplicate entries if page reloaded
- Preserves manual edits to localStorage

## Future Improvements

1. **Real-time updates** - WebSocket push when new report generated
2. **Report metadata file** - Scripts save `.json` alongside `.html`
3. **Persistent server storage** - SQLite/JSON file for cross-browser history
4. **Delete reports** - UI button to remove old reports
5. **Filter/search** - Filter by date, pass rate, or test count
6. **Export history** - Download all reports as ZIP

## Related Files

- **API Routes**: `RainbowAI/src/routes/admin/testing.ts`
- **Dashboard JS**: `RainbowAI/src/public/js/legacy-functions.js`
- **Test Scripts**:
  - `RainbowAI/scripts/test-autotest-optimized.js`
  - `RainbowAI/scripts/test-multilingual-concurrent.js`
- **Skill Docs**: `.claude/skills/test-rainbow-multilingual/SKILL.md`
- **Reports**: `RainbowAI/src/public/reports/autotest/*.html`

---

**Last Updated**: 2026-02-13
**Feature Status**: ✅ Implemented and Tested
**Rainbow AI Version**: Latest (7-tier intent pipeline)
