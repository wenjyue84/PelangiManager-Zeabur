<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Chat Debug</title>
  <style>
    body { font-family: monospace; padding: 20px; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Live Chat API Debug</h1>

  <div class="section">
    <h2>1. Test Conversations List API</h2>
    <button onclick="testConversations()">Test /api/rainbow/conversations</button>
    <div id="conversations-result"></div>
  </div>

  <div class="section">
    <h2>2. Test Specific Conversation API</h2>
    <input type="text" id="phone-input" placeholder="Enter phone (e.g., 60127088789)" style="width: 300px">
    <button onclick="testConversation()">Test /api/rainbow/conversations/{phone}</button>
    <div id="conversation-result"></div>
  </div>

  <div class="section">
    <h2>3. Test Live Chat Module Loading</h2>
    <button onclick="testLiveChatJS()">Check if LiveChat.js loads</button>
    <div id="liveChat-result"></div>
  </div>

  <script>
    async function testConversations() {
      const resultDiv = document.getElementById('conversations-result');
      resultDiv.innerHTML = '<p>Testing...</p>';

      try {
        const response = await fetch('/api/rainbow/conversations');
        const data = await response.json();

        if (response.ok) {
          resultDiv.innerHTML = `
            <p class="success">✅ API Working</p>
            <p>Found ${data.length} conversations</p>
            <pre>${JSON.stringify(data.slice(0, 3), null, 2)}</pre>
          `;
        } else {
          resultDiv.innerHTML = `<p class="error">❌ API Error: ${response.status}</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<p class="error">❌ Network Error: ${err.message}</p>`;
      }
    }

    async function testConversation() {
      const resultDiv = document.getElementById('conversation-result');
      const phone = document.getElementById('phone-input').value || '60127088789';
      resultDiv.innerHTML = '<p>Testing...</p>';

      try {
        const response = await fetch(`/api/rainbow/conversations/${encodeURIComponent(phone)}`);
        const data = await response.json();

        if (response.ok) {
          const userMessages = data.messages.filter(m => m.role === 'user');
          const assistantMessages = data.messages.filter(m => m.role === 'assistant');

          resultDiv.innerHTML = `
            <p class="success">✅ API Working</p>
            <p><strong>Phone:</strong> ${data.phone}</p>
            <p><strong>Name:</strong> ${data.pushName}</p>
            <p><strong>Total messages:</strong> ${data.messages.length}</p>
            <p><strong>User messages:</strong> ${userMessages.length}</p>
            <p><strong>Assistant messages:</strong> ${assistantMessages.length}</p>
            <p><strong>Last message:</strong></p>
            <pre>${JSON.stringify(data.messages[data.messages.length - 1], null, 2)}</pre>
            <p><strong>Recent messages (last 5):</strong></p>
            <pre>${JSON.stringify(data.messages.slice(-5), null, 2)}</pre>
          `;
        } else {
          resultDiv.innerHTML = `<p class="error">❌ API Error: ${response.status}</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<p class="error">❌ Network Error: ${err.message}</p>`;
      }
    }

    function testLiveChatJS() {
      const resultDiv = document.getElementById('liveChat-result');
      const tests = [];

      // Check if LiveChat module exists
      if (typeof window.LiveChat !== 'undefined') {
        tests.push('✅ LiveChat module loaded');
      } else {
        tests.push('❌ LiveChat module NOT loaded');
      }

      // Check if functions are exposed
      if (typeof window.loadLiveChat === 'function') {
        tests.push('✅ loadLiveChat function available');
      } else {
        tests.push('❌ loadLiveChat function NOT available');
      }

      // Check DOM elements
      if (document.getElementById('tab-live-chat')) {
        tests.push('✅ #tab-live-chat element exists');
      } else {
        tests.push('❌ #tab-live-chat element NOT found');
      }

      if (document.getElementById('lc-messages')) {
        tests.push('✅ #lc-messages element exists');
      } else {
        tests.push('❌ #lc-messages element NOT found');
      }

      resultDiv.innerHTML = tests.map(t => `<p>${t}</p>`).join('');
    }
  </script>
</body>
</html>
